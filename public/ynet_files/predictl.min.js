"use strict";window.predictlApi=window.predictlApi||function(cb){var pa=window.predictlApi;pa.or=pa.or||[];pa.or.push(cb)};window.predictlApi.initSelectors=function initSelectors(selectors){window.predictlApi.sel=selectors};(function(){var $;var pako;var companyId;var clickTrackUrl=window.predictlApi.clickTrackUrl;var externalReqId=window.predictlApi.externalReqId;var isDmpEnable=1;var timeout=4e3;var preReadySendApiDataQueue;var callbackResults={};var callbackQueues={};var processedSegments=[];var config={appServer:"//server-r1.exposebox.com",sfServer:"//sf.exposebox.com",load:function(){this.apiRequestUrl=this.appServer+"/cap";this.jQueryUrl=this.sfServer+"/widget/jQuery/jquery-1.12.1.min.js";this.pakoUrl=this.sfServer+"/widget/pako/pako_deflate.min.js";this.layoutBaseUrl=this.appServer+"/layouts/"}};var utils={getItem:function(key){try{return localStorage.getItem(key)}catch(e){var cookies=document.cookie.split("; ");for(var i in cookies){var keyVal=cookies[i].split("=");if(keyVal[0]===escape(key)&&keyVal[1]!==undefined){return unescape(keyVal[1])}}return}},setItem:function(key,value){try{localStorage.setItem(key,value)}catch(e){document.cookie=escape(key)+"="+escape(value)+"; expires=Tue, 19 Jan 2038 03:14:07 GMT; path=/"}},loadScript:function(url,callback){var script=document.createElement("script");script.type="text/javascript";script.async=true;script.src=url;script.onload=callback;document.getElementsByTagName("head")[0].appendChild(script)},loadUrlWithImage:function(url,deferred){var imageLoadComplete=function(){deferred.resolve()};var loadUrlImage=new Image;loadUrlImage.src=url;loadUrlImage.onload=imageLoadComplete;loadUrlImage.onerror=imageLoadComplete;loadUrlImage.onabort=imageLoadComplete;return deferred.promise()},loadPerformancePixel:function(metric,tags){var loadUrlImage=new Image;var queryString={c:companyId,m:metric,_:Date.now()};if(!$.isEmptyObject(tags)){queryString.t=tags}loadUrlImage.src=config.appServer+"/statsd-increment?"+$.param(queryString)},getParameterByName:function(url,name,isCaseSensitive){name=name.replace(/[\[\]]/g,"\\$&");if(!isCaseSensitive)name=name.toLowerCase();var results=new RegExp("[?&]"+name+"(=([^&#]*)|&|#|$)").exec(isCaseSensitive?url:url.toLowerCase());if(!results)return null;if(!results[2])return"";var parameterValue=results[2].replace(/\+/g," ");return utils.safeDecodeURIComponent(parameterValue)},safeDecodeURIComponent:function(urlComponent){try{urlComponent=decodeURIComponent(urlComponent)}catch(e){}return urlComponent},firstGet:1,getJsonp:function(url,json){json.fget=this.firstGet;this.firstGet=0;var compressedData;var disableZqs=utils.getParameterByName(window.location.href,"_ex_disable_zqs")==="";if(typeof Uint8Array!=="undefined"&&!disableZqs){var queryJsonStringUtf16=JSON.stringify(json);if(queryJsonStringUtf16.length>500){var queryJsonStringUtf8=encodeURIComponent(queryJsonStringUtf16);var compressedQueryString=pako.deflate(queryJsonStringUtf8);var compressedQueryString64=utils.arrayToBase64String(compressedQueryString);if(compressedQueryString64.length<queryJsonStringUtf16.length){compressedData={_zqs:compressedQueryString64}}}}var requestData={type:"GET",url:url,scriptCharset:"utf-8",dataType:"jsonp",data:compressedData||json,timeout:timeout};if(json.placementIds&&json.placementIds.length>0){requestData.timeout=timeout*20}return $.ajax(requestData).done(utils.getJsonpDoneHandler).fail(utils.getJsonpFailHandler)},getJsonpDoneHandler:function(data,textStatus,xhr){if(xhr.status!==200){utils.loadPerformancePixel("predictl.request.error",{status:xhr.status})}},getJsonpFailHandler:function(xhr,textStatus,errorThrown){if(textStatus==="parsererror")return;utils.loadPerformancePixel("predictl.request.error",{status:xhr.status,statusText:textStatus})},trigger:function(el,name,data){var event;if(typeof window.CustomEvent==="function"){event=new CustomEvent(name,{detail:data})}else{event=document.createEvent("CustomEvent");event.initCustomEvent(name,true,true,data)}el.dispatchEvent(event)},groupBy:function(array,fieldName){var onePerPageElements=["customer"];var groups={};for(var i=0;i<array.length;i++){var item=array[i];var itemFieldValue=item[fieldName];delete item[fieldName];var itemGroup=groups[itemFieldValue];if(onePerPageElements.indexOf(itemFieldValue)>-1){groups[itemFieldValue]=item}else if(!itemGroup){groups[itemFieldValue]=[item]}else{itemGroup.push(item)}}return groups},compactObject:function(obj){var keys=Object.keys(obj);if(keys.length===1){return obj[keys[0]]}else if(keys.length===2&&"key"in obj&&"value"in obj){var rtnObj={};rtnObj[obj["key"]]=obj["value"];return rtnObj}return obj},isUndefinedOrNull:function(obj){return obj===null||obj===void 0},addToCallbackQueue:function(label,callback){var callbackResult=callbackResults[label];if(callbackResult){return callback(callbackResult.data)}if(!callbackQueues[label]){callbackQueues[label]=[callback]}else{callbackQueues[label].push(callback)}},resolveCallbackQueue:function(label,error,result){callbackResults[label]={data:result};var callbackQueue=callbackQueues[label];if(!callbackQueue){return}while(0<callbackQueue.length){var callback=callbackQueue.shift();if(callback){try{if(error){callback(error)}else{callback(null,result)}}catch(err){console&&console.error("Website raised an error.",err.stack||err)}}}},deferredToCallback:function(deferred,callback){deferred.then(function(result){callback(null,result)},function(error){callback(error)})},safeGetProperty:function(object,propertyPath){if(object==null)return null;var currentObj=object;var fields=propertyPath.split(".");for(var i=0;i<fields.length;i++){var field=fields[i];if(currentObj[field]==null)return null;currentObj=currentObj[field]}return currentObj},safeJsonParse:function(jsonStr,fallbackValue){try{return JSON.parse(jsonStr)}catch(e){return fallbackValue}},arrayToBase64String:function(arrayBuffer){var base64="";var encodings="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var bytes=new Uint8Array(arrayBuffer);var byteLength=bytes.byteLength;var byteRemainder=byteLength%3;var mainLength=byteLength-byteRemainder;var a,b,c,d;var chunk;for(var i=0;i<mainLength;i=i+3){chunk=bytes[i]<<16|bytes[i+1]<<8|bytes[i+2];a=(chunk&16515072)>>18;b=(chunk&258048)>>12;c=(chunk&4032)>>6;d=chunk&63;base64+=encodings[a]+encodings[b]+encodings[c]+encodings[d]}if(byteRemainder==1){chunk=bytes[mainLength];a=(chunk&252)>>2;b=(chunk&3)<<4;base64+=encodings[a]+encodings[b]+"=="}else if(byteRemainder==2){chunk=bytes[mainLength]<<8|bytes[mainLength+1];a=(chunk&64512)>>10;b=(chunk&1008)>>4;c=(chunk&15)<<2;base64+=encodings[a]+encodings[b]+encodings[c]+"="}return base64}};var eventBus={initialize:function(){var jQueryEventBus=$({});this.on=jQueryEventBus.on.bind(jQueryEventBus);this.off=jQueryEventBus.off.bind(jQueryEventBus);this.trigger=jQueryEventBus.trigger.bind(jQueryEventBus);apiMethods.on=this.on;apiMethods.off=this.off},triggerPlacementReady:function(placementId,placementData){var placement={id:placementId};var placementSelector=placementsSelector.getPlacementSelector(placementId);if(placementSelector){placement.selector=placementSelector}this.trigger("placement:ready",$.extend(placement,placementData))}};var markPlacement={getPlacement:function(){var placementSelector=utils.getParameterByName(window.location.href,"__ex_pl_sel__",true);if(placementSelector==null||placementSelector.length<1)return null;try{var ele=$(placementSelector);if(ele==null||ele.length===0)return null;return ele}catch(e){return null}},markPlacement:function(){var placement=this.getPlacement();if(placement){placement.css("outline","red dashed 5px");placement.children().css("opacity",.5);placement.css("background-image","linear-gradient(45deg, #ECECEC 25%, transparent 25%), linear-gradient(-45deg, #ECECEC 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ECECEC 75%), linear-gradient(-45deg, transparent 75%, #ECECEC 75%)");placement.css("background-size","20px 20px");placement.css("background-position","0 0, 0 10px, 10px -10px, -10px 0px");placement[0].scrollIntoView(true)}}};var selectorsCache={loadSelectors:function(callback){var apiSelectorsUrl=config.appServer+"/selectors";var currentSlu=this.getOrInitialize();utils.loadScript(apiSelectorsUrl+"?c="+companyId+"&slu="+currentSlu,callback)},getSlu:function(){var currentSlu=utils.getItem(this.getSluKeyName());if(currentSlu==null){return null}currentSlu=parseInt(currentSlu);if(isNaN(currentSlu)){return null}return currentSlu},getOrInitialize:function(){var currentSlu=this.getSlu();if(currentSlu==null){currentSlu=Date.now();this.updateSluIfNeeded(currentSlu)}return currentSlu},updateSluIfNeeded:function(responseSlu){if(responseSlu==null)return;var currentSlu=this.getSlu();if(currentSlu==null||responseSlu>currentSlu){utils.setItem(this.getSluKeyName(),responseSlu)}},getSluKeyName:function(){return"ex-slu-"+companyId}};var placementsSelector={filterByRules:function(selectors){var ps=selectors.ps;if(ps==null)return;for(var placementId in ps){var selector=ps[placementId];if(!selector.urlRule&&!selector.jsVariable)continue;if(selector.urlRule&&this.isPageMatch(window.location.href,selector.urlRule))continue;if(selector.jsVariable&&this.isPageMatch(window[selector.jsVariable.name],selector.jsVariable))continue;delete ps[placementId]}},isPageMatch:function(pageData,matcher){if(pageData==null)return false;if(matcher.pattern==null||matcher.type==null){return true}if(matcher.type==="starts"&&pageData.indexOf(matcher.pattern)===0){return true}else if(matcher.type==="contains"&&pageData.indexOf(matcher.pattern)!==-1){return true}else if(matcher.type==="ends"&&pageData.indexOf(matcher.pattern)===pageData.length-matcher.pattern.length){return true}else if(matcher.type==="regex"&&new RegExp(matcher.pattern).test(pageData)){return true}return false},getPlacementSelector:function(placementId){var selectors=window.predictlApi.sel;if(selectors.ps!=null){return window.predictlApi.sel.ps[placementId]}},getPlacementIdsFromPlacementSelectors:function(){var placementIds=[];var selectors=window.predictlApi.sel;if(selectors.ps!=null){for(var placementId in selectors.ps){var placementElement=getPlacementElementById(placementId);if(placementElement!=null&&placementElement.length>0||placementId==="jde8lroa"){placementIds.push(placementId)}}}return placementIds},appendResourcePlacements:function(apiByResource){var placementIdsFromSelectors=this.getPlacementIdsFromPlacementSelectors();if(placementIdsFromSelectors.length>0){apiByResource.placementIds=placementIdsFromSelectors.concat(apiByResource.placementIds||[])}}};var tagsSelector={getTagSubsBySelector:function(selector){if(selector.type==="variable"){var tagSubs=window[selector.selector];if(tagSubs){if($.isArray(tagSubs)){return tagSubs}else if(Object.prototype.toString.call(tagSubs)==="[object String]"){return[tagSubs]}}}return null},getTags:function(){var selectors=window.predictlApi.sel;var tags={};if(selectors.ts!=null){for(var tagWord in selectors.ts){var tagSelector=selectors.ts[tagWord];var tagSubs=this.getTagSubsBySelector(tagSelector);if(tagSubs){tags[tagWord]=tagSubs}}}return tags},appendResourceTags:function(apiByResource){var tags=this.getTags();if(!$.isEmptyObject(tags)){apiByResource.tags=$.extend({},apiByResource.tags,tags)}}};var htmlBuilder={functionRegExps:{pickRandom:{regExp:new RegExp("{{s*(pickRandom)\\(([^\\)]+)\\)s*}}","g"),invoke:function(array){return array[Math.floor(Math.random()*array.length)]}}},applyFunctions:function(itemHtml,item){for(var functionRegExpKey in this.functionRegExps){var functionRegExp=this.functionRegExps[functionRegExpKey];itemHtml=itemHtml.replace(functionRegExp.regExp,function(match,functionName,argument){try{argument=argument.replace(new RegExp("^product.","i"),"");var propertyValue=utils.safeGetProperty(item,argument);if($.isEmptyObject(propertyValue))return"";return functionRegExp.invoke(propertyValue)}catch(e){return""}})}return itemHtml},buildHtml:function(placementId,layout,placementData){var placementElement=getPlacementElementById(placementId);var headerHtml=layout.header;var itemHtmlTemplate=layout.product;var footerHtml=layout.footer;var itemType=$.isEmptyObject(placementData.products)?"banner":"product";var items=itemType==="banner"?placementData.banners:placementData.products;var urlPrefix=placementElement.data("ui-url-prefix");var urlSuffix=placementElement.data("ui-url-suffix");for(var i=0;i<items.length;i++){var item=items[i];var itemTypeId=recommendedItems.getItemTypeId(itemType,item.id);var itemHtml=itemHtmlTemplate;if(item.url&&urlSuffix&&urlSuffix.length>0){item.url=item.url+(item.url.indexOf("?")>0?"&":"?")+urlSuffix}if(item.url&&urlPrefix&&urlPrefix.length>0){item.url=urlPrefix+encodeURIComponent(item.url)}for(var itemKey in item){var itemValue=item[itemKey];if(itemKey==="freeData")continue;itemValue=utils.isUndefinedOrNull(itemValue)?"":itemValue;if(itemValue&&itemValue.constructor===Array){for(var itemValuesIndex=0;itemValuesIndex<itemValue.length;itemValuesIndex++){itemHtml=itemHtml.replace(new RegExp("{{product."+itemKey+"\\["+itemValuesIndex+"\\]}}","g"),itemValue[itemValuesIndex])}}else{itemHtml=itemHtml.replace(new RegExp("{{product."+itemKey+"}}","g"),itemValue)}}var freeData=item.freeData;if(!$.isEmptyObject(freeData)){for(var freeDataKey in freeData){var freeDataValue=freeData[freeDataKey];freeDataValue=utils.isUndefinedOrNull(freeDataValue)?"":freeDataValue;if(freeDataValue&&freeDataValue.constructor===Array){for(var freeDataValuesIndex=0;freeDataValuesIndex<freeDataValue.length;freeDataValuesIndex++){var freeDataKeyRegex="{{product.freeData."+freeDataKey+"\\["+freeDataValuesIndex+"\\]}}";itemHtml=itemHtml.replace(new RegExp(freeDataKeyRegex,"g"),freeDataValue[freeDataValuesIndex])}}else{itemHtml=itemHtml.replace(new RegExp("{{product.freeData."+freeDataKey+"}}","g"),freeDataValue)}}}itemHtml=this.applyFunctions(itemHtml,item);itemHtml=itemHtml.replace(/<a /g,'<a data-tid="'+itemTypeId+'" ').replace(/<a>/g,'<a data-tid="'+itemTypeId+'" >');headerHtml=headerHtml+itemHtml}var fullHtml=(headerHtml+footerHtml).replace(new RegExp("{{.+?}}","g"),"");placementElement.html(fullHtml);addClickHandler(placementElement,placementId,placementData)}};var realImpression={pendingRealImpressionBatch:[],initialize:function(){setInterval(function(){var realImpressionBatch=realImpression.pendingRealImpressionBatch;if(realImpressionBatch.length>0){apiMethods.events.realImpression(realImpressionBatch);realImpression.pendingRealImpressionBatch=[]}},3e3)},processRealImpression:function(placementId,placementData){function isElementInViewport(element){var rect=element.getBoundingClientRect();return rect.top>=0&&rect.left>=0&&rect.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&rect.right<=(window.innerWidth||document.documentElement.clientWidth)}var isInIframe=window.location!=window.parent.location;if(!isInIframe){var checkWidgetViewedInterval=setInterval(function(){var widgetElement=getPlacementElementById(placementId).get(0);if(widgetElement&&isElementInViewport(widgetElement)){realImpression.sendEvent(placementId,placementData);clearInterval(checkWidgetViewedInterval)}},500)}},sendEvent:function(placementId,placementData){var placementItems=(recommendedItems.getItemsByPlacement(placementId)||[]).map(function(recommendedItem){return{id:recommendedItem.id,itemType:recommendedItem.itemType,catalogId:recommendedItem.catalogId,category:recommendedItem.category,brand:recommendedItem.brand}});this.pendingRealImpressionBatch.push({placementId:placementId,widgetId:placementData.widgetId,items:placementItems})}};var recommendedItems={itemsByTypeId:{},itemsByPlacementId:{},getItemTypeId:function(itemType,itemId){return itemType+"|"+itemId},getItemByTypeId:function(itemTypeId){return this.itemsByTypeId[itemTypeId]},getItemsByPlacement:function(placementId){return recommendedItems.itemsByPlacementId[placementId]},setItems:function(itemType,items,placementId){$.each(items,function(index,item){recommendedItems.itemsByTypeId[itemType+"|"+item.id]=item;if(!recommendedItems.itemsByPlacementId[placementId]){recommendedItems.itemsByPlacementId[placementId]=[item]}else{recommendedItems.itemsByPlacementId[placementId].push(item)}})}};var eventsStorageBackup={getEventStorageKey:function(eventType){return"_"+companyId.toString(36)+"_exc$"+eventType},sendEventWithRetryOnuload:function(eventType,eventData){try{window.sessionStorage.setItem(eventsStorageBackup.getEventStorageKey(eventType),JSON.stringify(eventData));sendEventApiRequestWithScriptResponse(eventType,eventData)}catch(e){}},sendStoredEvents:function(eventType){try{var eventData=utils.safeJsonParse(window.sessionStorage.getItem(eventsStorageBackup.getEventStorageKey(eventType)));if(eventData){sendEventApiRequestWithScriptResponse(eventType,eventData)}}catch(e){}}};var userIdStorage={getUserId:function(){var queryExi=utils.getParameterByName(window.location.href,"exi",true);return queryExi||utils.getItem("__exi")},setUserId:function(userId){utils.setItem("__exi",userId)}};var apiMethods={addClickHandler:addClickHandler,setProducts:function(products){var requestSetProduct={products:products};sendApiRequests(requestSetProduct)},setTags:function(tags){var requestSetSegments={tags:tags};sendApiRequests(requestSetSegments)},setCustomerData:function(customerData){var requestSetCustomerData={customer:customerData};sendApiRequests(requestSetCustomerData)},setCategories:function(categoryNames){var requestSetCategories={categoryNames:categoryNames};sendApiRequests(requestSetCategories)},getExposeBoxUserId:function(callback){utils.addToCallbackQueue("getExposeBoxUserId",callback)},getPlacementRecommendations:function(placementIds,callback){var requestGetPlacements={placementIds:placementIds};var sendApiRequestsResult=sendApiRequests(requestGetPlacements);var callbackPlacements=function(err,result){callback(err,result&&result.placements||{})};if(!sendApiRequestsResult){utils.addToCallbackQueue("getPlacementRecommendations",callbackPlacements)}else{utils.deferredToCallback(sendApiRequestsResult,callbackPlacements)}},events:{realImpression:function(realImpressionBatch){return sendEventApiRequest("realImpression",realImpressionBatch)},click:function(placementId,widgetId,productId,clickType,additionalData){var eventData={placementId:placementId,widgetId:widgetId,productId:productId,ct:clickType||"L"};if(!$.isEmptyObject(additionalData)){$.extend(eventData,additionalData)}return sendEventApiRequest("click",eventData)},conversion:function(cartProducts,orderId,totalPrice){return eventsStorageBackup.sendEventWithRetryOnuload("conversion",{cartProducts:cartProducts,orderId:orderId,totalPrice:totalPrice})},addToCart:function(productId,quantity,unitPrice){return sendEventApiRequest("addToCart",{productId:productId,quantity:quantity,unitPrice:unitPrice})},removeFromCart:function(productId,quantity){return sendEventApiRequest("removeFromCart",{productId:productId,quantity:quantity})},addToWishlist:function(productId){return sendEventApiRequest("addToWishlist",{productId:productId})},removeFromWishlist:function(productId){return sendEventApiRequest("removeFromWishlist",{productId:productId})},search:function(searchQuery,returnedProductIds){return sendEventApiRequest("search",{query:searchQuery,productIds:returnedProductIds})},sendCustomEvent:sendEventApiRequest,sendEvent:sendEventApiRequest},refreshPageData:predictlFlow};function sendEventApiRequest(eventType,eventData){var eventRequest={c:companyId,dmp:isDmpEnable,erId:externalReqId,exi:userIdStorage.getUserId()};eventRequest[eventType]=eventData;return utils.getJsonp(config.apiRequestUrl+"/events",eventRequest)}function sendEventApiRequestWithScriptResponse(eventType,eventData){var eventRequest={c:companyId,dmp:isDmpEnable,erId:externalReqId,exi:userIdStorage.getUserId()};eventRequest[eventType]=eventData;return $.getScript(config.apiRequestUrl+"/events?"+$.param(eventRequest))}function processApiResponse(recommendationContext){processSegmentsResponse(recommendationContext.segments);if(recommendationContext.userId){userIdStorage.setUserId(recommendationContext.userId.toString(36))}return recommendationContext}function sendApiRequests(requestDataSet,purgePreReadySendApiDataQueue){requestDataSet.c=companyId;requestDataSet.dmp=isDmpEnable;requestDataSet.erId=externalReqId;requestDataSet.exi=userIdStorage.getUserId();if(!preReadySendApiDataQueue){return utils.getJsonp(config.apiRequestUrl,requestDataSet).then(processApiResponse)}preReadySendApiDataQueue.push(requestDataSet);if(purgePreReadySendApiDataQueue){$.each(preReadySendApiDataQueue,function(index,preReadySendApiData){$.extend(requestDataSet,preReadySendApiData)});preReadySendApiDataQueue=null;return utils.getJsonp(config.apiRequestUrl,requestDataSet).then(processApiResponse)}}function compactApiRequest(apiList,apiName){if(!apiList[apiName])return apiList;var compactApi={};$.each(apiList[apiName],function(index,keyValueObj){for(var key in keyValueObj){compactApi[key]&&compactApi[key].push(keyValueObj[key])||(compactApi[key]=[keyValueObj[key]])}});apiList[apiName]=compactApi;return apiList}function loadLibrariesAndSelectors(callback){var callbackCounter=0;var callbackCounterFunc=function(){callbackCounter++;if(callbackCounter===3){callback()}};utils.loadScript(config.jQueryUrl,function(){$=jQuery.noConflict(true);callbackCounterFunc()});utils.loadScript(config.pakoUrl,function(){pako=window.predictlApi.pako;callbackCounterFunc()});selectorsCache.loadSelectors(callbackCounterFunc)}function getPlacementElementById(placementId){var placementSelector=placementsSelector.getPlacementSelector(placementId);try{if(placementSelector!=null){return $(placementSelector.selector)}else{return $("#"+placementId)}}catch(e){return null}}function displayWidget(placementId,placementData){var layoutUrl=config.layoutBaseUrl+"?cid="+companyId+"&id="+placementData.layoutId+"&cb="+placementData.layoutUpdateTime;return $.ajax({dataType:"json",url:layoutUrl,timeout:timeout}).done(function(layout){htmlBuilder.buildHtml(placementId,layout,placementData)})}function displayBannerWidget(placementId,placementData){var layout={header:"",product:'<a href="{{product.url}}" target="_blank"><img src="{{product.imageUrl}}"></a>',footer:""};htmlBuilder.buildHtml(placementId,layout,placementData)}function displaySnippet(placementId,placementData,retires){var selector=getPlacementElementById(placementId);if(selector[0]){getPlacementElementById(placementId).html(placementData.snippet)}else{retires=retires||0;setTimeout(function(){if(retires<=3)displaySnippet(placementId,placementData,retires+1)},300*(retires+1))}}function displayBannerWithSnippet(placementId,placementData){var iFrameTemplate='<iframe src="'+config.appServer+'/banner/if?c={{c}}&bni={{bni}}&clicktr={{clicktr}}" '+'style="width:{{w}}px; height:{{h}}px;" frameborder="0" scrolling="no" ></iframe>';iFrameTemplate=iFrameTemplate.replace("{{c}}",companyId).replace("{{bni}}",placementData.banners[0].id).replace("{{w}}",placementData.banners[0].width).replace("{{h}}",placementData.banners[0].height).replace("{{clicktr}}",encodeURIComponent("https:"+config.apiRequestUrl+"/events?c="+companyId+"&dmp=0&click%5BplacementId%5D="+placementId+"&click%5BwidgetId%5D="+placementData.widgetId+"&click%5BproductId%5D="+placementData.banners[0].id+"&click%5Bct%5D=L"+"&ref="));var iFrameElement=$(iFrameTemplate);iFrameElement.appendTo(getPlacementElementById(placementId));$(iFrameElement).on("load",function(){addClickHandler($($(iFrameElement).contents()))})}function create3rdPartyDefer(){var defer3rdPartyPromise=$.Deferred();if(clickTrackUrl){utils.loadUrlWithImage(clickTrackUrl,defer3rdPartyPromise)}else{defer3rdPartyPromise.resolve()}return defer3rdPartyPromise}function create1stPartyDefer(event,clickType,placementId,placementData){var itemTypeId=$(event.currentTarget).closest("[data-tid]").data("tid");if(!itemTypeId){var defer1stParty=$.Deferred();defer1stParty.resolve();return defer1stParty}var recommendedItem=recommendedItems.getItemByTypeId(itemTypeId);var additionalData;if(recommendedItem.bsrId){additionalData={bsrId:recommendedItem.bsrId}}return apiMethods.events.click(placementId,placementData.widgetId,recommendedItem.id,clickType,additionalData)}function addClickHandler(element,placementId,placementData){element.on("mouseup click","a",function(event){var clickType;switch(event.which){case 1:clickType="L";break;case 2:clickType="M";break;case 3:clickType="R";break}if(event.type==="mouseup"&&clickType==="L")return;var openSameWindow=$(event.currentTarget).attr("target")!=="_blank";if(openSameWindow)event.preventDefault();var defer1stParty=create1stPartyDefer(event,clickType,placementId,placementData);var defer3rdParty=create3rdPartyDefer();$.when(defer1stParty,defer3rdParty).always(function(){if(event.type==="click"&&openSameWindow){window.top.location.href=event.currentTarget.href}})})}function getReadyFuncApiData(onReadyFuncQueue){if(!onReadyFuncQueue)return;preReadySendApiDataQueue=[];$.each(onReadyFuncQueue,function(index,func){func()})}function processSegmentsResponse(segments){var onlineAudiencesURI="";segments=$(segments).not(processedSegments).get();Array.prototype.push.apply(processedSegments,segments);if(segments&&segments.length>0){onlineAudiencesURI="&oa="+segments.join(",")}if(0<isDmpEnable){$(function(){$('<iframe src="'+config.appServer+"/dmp/iftags?c="+companyId+onlineAudiencesURI+'" height="0" width="0" frameBorder="0" style="display: block;" ></iframe>').appendTo("body")})}}function getPredictlUrlParameters(){var scripts=document.getElementsByTagName("script");for(var i=0;i<scripts.length;i++){var script=scripts[i];if(script.src.indexOf("predictl.min.js")>-1||script.src.indexOf("predictl.js")>-1){companyId=parseInt(utils.getParameterByName(script.src,"c"));var dmpAttr=utils.getParameterByName(script.src,"dmp");isDmpEnable=dmpAttr===null?1:parseInt(dmpAttr);break}}}function getApiByResourceFromHtml(){var predictlApiDataSet=$(".predictl-api-data, .predictl-placement").map(function(index,apiElement){var elementData=$(apiElement).clone().data();for(var elementDataKey in elementData){if(elementDataKey.indexOf("ui")===0){delete elementData[elementDataKey]}}if($(apiElement).hasClass("predictl-placement")){elementData.id=apiElement.id;elementData.resource="placementIds"}else{var childrenData=$(apiElement).children().map(function(idx,child){return $(child).data()}).filter(function(idx,child){return!$.isEmptyObject(child)});if(childrenData&&childrenData.length>0){return childrenData.map(function(idx,child){return $.extend(child,elementData)}).get()}}return elementData}).get();var apiByResource=utils.groupBy(predictlApiDataSet,"resource");for(var resourceKey in apiByResource){if($.isArray(apiByResource[resourceKey])){apiByResource[resourceKey]=apiByResource[resourceKey].map(utils.compactObject)}}return compactApiRequest(apiByResource,"tags")}function initPredictl(){eventBus.initialize();markPlacement.markPlacement();var onReadyFuncQueue=window.predictlApi&&window.predictlApi.or;var selectors=window.predictlApi&&window.predictlApi.sel;window.predictlApi=function(func){return func()};window.predictlApi.sel=selectors;$.extend(window.predictlApi,apiMethods,{jQuery:$});getReadyFuncApiData(onReadyFuncQueue)}function predictlFlow(){var clickTrackUrlQuery=utils.getParameterByName(window.location.href,"clicktr",true);if(clickTrackUrlQuery&&clickTrackUrlQuery.indexOf("http")>=0){clickTrackUrl=utils.safeDecodeURIComponent(clickTrackUrlQuery)}eventsStorageBackup.sendStoredEvents("conversion");var selectors=window.predictlApi&&window.predictlApi.sel;placementsSelector.filterByRules(selectors);utils.trigger(window,"predictl:ready",window.predictlApi);var apiByResource=getApiByResourceFromHtml();placementsSelector.appendResourcePlacements(apiByResource);tagsSelector.appendResourceTags(apiByResource);sendApiRequests(apiByResource,true).done(function(recommendationContext){selectorsCache.updateSluIfNeeded(recommendationContext.slu);var placements=recommendationContext.placements;utils.resolveCallbackQueue("getExposeBoxUserId",recommendationContext.userId,recommendationContext.userId);utils.resolveCallbackQueue("getPlacementRecommendations",null,recommendationContext);if(!$.isEmptyObject(placements)){realImpression.initialize();$.each(placements,function(placementKey,placementData){if(!placementData){return}if(placementData.products){recommendedItems.setItems("product",placementData.products,placementKey);displayWidget(placementKey,placementData).done(function(){realImpression.processRealImpression(placementKey,placementData);eventBus.triggerPlacementReady(placementKey,placementData)})}var banner=placementData.banners&&placementData.banners[0];if(banner){recommendedItems.setItems("banner",placementData.banners,placementKey);var displayBanner=function(){if(banner.snippet){return displayBannerWithSnippet(placementKey,placementData)}else{return displayBannerWidget(placementKey,placementData)}};displayBanner();realImpression.processRealImpression(placementKey,placementData);eventBus.triggerPlacementReady(placementKey,placementData)}if(placementData.snippet){displaySnippet(placementKey,placementData);eventBus.triggerPlacementReady(placementKey,placementData)}})}})}config.load();getPredictlUrlParameters();loadLibrariesAndSelectors(function(){if(!companyId)return;initPredictl();predictlFlow()})})();